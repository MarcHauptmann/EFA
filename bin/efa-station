#!/usr/bin/perl

use EFA;
use Text::Table;
use Getopt::Long;
use Pod::Usage;
use EFA::DB;
use utf8;

binmode(STDOUT, ":utf8");

sub show_help {
  pod2usage(verbose => 99,
            sections => [ qw(SYNOPSIS COMMANDS OPTIONS) ]);
}

sub find_stations {
  my $query = $_[0];

  my @stations = find_station($query);

  if (scalar(@stations) > 0) {
    printStations(@stations);
  } else {
    print "keine Stationen gefunden\n";
  }
}

sub add_station {
  my $id = $_[0];

  my @stations = find_station($id);

  my $station = $stations[0];

  if ($station) {
    my $name = $station->get_name;
    my $id = $station->get_id;
    print "$name: $id\n";

    store_station(\$station);
  }
}

sub list_stations {
  printStations(load_all_stations());
}

sub remove_station {
  my $id = $_[0];

  delete_station($id);
}

sub printStations {
  my $table = Text::Table->new("Station", "ID");

  foreach $station (@_) {
    $table->add($station->get_name, $station->get_id);
  }

  print $table->title;
  print $table->rule("-");
  print $table->body;
}

sub main {
  init_db();

  my $command = shift @ARGV;

  if ($command eq "search") {
    GetOptions("<>" => \&find_stations,
               "help" => \&show_help);
  } elsif ($command eq "add") {
    GetOptions("<>" => \&add_station,
               "help" => \&show_help);
  } elsif ($command eq "rm") {
    GetOptions("<>" => \&remove_station,
               "help" => \&show_help);
  } elsif ($command eq "list") {
    list_stations();
  } else {
    print "unbekanntes Kommando: $command\n";

    show_help();
  }

  close_db();
}

main();

__END__

=encoding utf8

=head1 NAME

B<efa-station> - Verwaltet Haltestellen

=head1 SYNOPSIS

=over 8

=item I<efa-station add> <id>

=item I<efa-station list>

=item I<efa-station rm> <id>

=item I<efa-station search> <name>

=back

=head1 COMMANDS

=over 8

=item I<add> <id>

Fügt eine Haltestelle mit der ID <id> zur Datenbank hinzu

=item I<list>

Listet alle Haltestellen in der Datenbank auf

=item I<rm> <id>

Löscht eine Haltestelle aus der lokalen Datenbank

=item I<search> <name>

Sucht in der Datenbank von L<efa.de|http://efa.de> nach der Station mit dem Namen <name>

=back

=head1 OPTIONS

=over 8

=item B<--help>

Zeigt diese Hilfe

=back


